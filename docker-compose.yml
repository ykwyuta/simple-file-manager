version: '3.8'
services:
  # 1. PostgreSQL Database
  db:
    image: postgres:17-alpine
    container_name: file-manager-db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: filemanager_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # 2. S3-Compatible Storage (Garage)
  garage:
    image: dxflrs/garage:v2.1.0
    container_name: file-manager-garage
    ports:
      - "3900:3900" # S3 API
      - "3903:3903" # Admin API
    volumes:
      - ./garage.toml:/etc/garage.toml:ro
      - garage_meta:/var/lib/garage/meta
      - garage_data:/var/lib/garage/data
    environment:
      - RUST_LOG=garage=info
    healthcheck:
      test: [ "CMD", "/garage", "status" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # 3. Spring Boot Application
  app:
    build: .
    container_name: file-manager-app
    ports:
      - "8080:8080"
    depends_on:
      - db
      - garage
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/filemanager_db
      SPRING_DATASOURCE_USERNAME: user
      SPRING_DATASOURCE_PASSWORD: password
      # Garage S3 connection settings
      S3_ENDPOINT_URL: http://garage:3900
      # Real credentials generated via Garage CLI
      S3_ACCESS_KEY: GKff80f0a15593a2706adf01cd
      S3_SECRET_KEY: c7edb67b2b38b42263e21d27c2efb37a28d1dc16159ec487e69f81a4e790c108
      S3_BUCKET_NAME: files
      # Awspring Cloud specific properties for S3
      spring.cloud.aws.s3.endpoint: http://garage:3900
      spring.cloud.aws.credentials.access-key: GKff80f0a15593a2706adf01cd
      spring.cloud.aws.credentials.secret-key: c7edb67b2b38b42263e21d27c2efb37a28d1dc16159ec487e69f81a4e790c108
      spring.cloud.aws.region.static: us-east-1
      spring.cloud.aws.s3.path-style-access-enabled: "true"

volumes:
  postgres_data:
  garage_meta:
  garage_data:
