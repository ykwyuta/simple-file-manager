# 設計書: フォルダ階層管理

## 1. 概要

本システムにおけるフォルダの階層構造の管理方法、およびユーザーによるナビゲーションに関する仕様を定義する。
ファイルシステムのような親子関係を持つフォルダ階層を実現し、ユーザーが直感的に操作できるUIを提供する。

## 2. データモデル

フォルダの階層構造は、各フォルダ（またはファイル）が自身の親フォルダIDを持つことで表現する。

| フィールド名 | データ型 | 説明 | 備考 |
| :--- | :--- | :--- | :--- |
| `id` | Long | 一意な識別子 (主キー) | |
| `parent_folder_id` | Long | 親フォルダのID | ルートフォルダの場合は `NULL` となる。 |
| `name` | String | フォルダ名 | |
| `is_directory` | Boolean | `true` に固定 | |
| ... | ... | 他のメタデータ | 所有者、権限など。詳細は[メタデータ仕様書](./metadata_schema.md)を参照。 |

### 2.1. ルートフォルダ

-   システムの最上位階層には、`parent_folder_id`が`NULL`であるルートフォルダが一つ存在する。
-   ユーザーごとのホームディレクトリのような概念を導入する場合、ルートフォルダ配下にユーザー名のフォルダを自動生成するなどの仕様も考えられる。

## 3. 機能要件

| No. | 機能 | 概要 | 詳細 |
| :--- | :--- | :--- | :--- |
| 3.1 | フォルダ作成 | ユーザーが新しいフォルダを作成する機能。 | ・現在の階層（または指定した階層）に作成する。<br>・作成には、親フォルダに対する書き込み権限(`w`)が必要。 |
| 3.2 | 階層表示 | フォルダの階層構造を一覧で表示する機能。 | ・現在のフォルダに含まれるファイルとサブフォルダを一覧表示する。<br>・パンくずリスト（例: `ルート > documents > work`）を画面上部に表示し、現在位置を明確にする。 |
| 3.3 | 階層移動（ナビゲーション） | ユーザーがフォルダ間を移動する機能。 | ・一覧のサブフォルダ名をクリックすると、そのフォルダに移動する。<br>・パンくずリストのリンクをクリックすると、上位の階層に直接移動できる。<br>・フォルダへのアクセスには、対象フォルダに対する実行権限(`x`)が必要。 |

## 4. APIエンドポイント（案）

| メソッド | URI | 説明 |
| :--- | :--- | :--- |
| `POST` | `/folders?path=/...` | 指定したパスに新しいフォルダを作成する |
| `GET` | `/items?path=/...` | 指定したパス（フォルダ）の内容（ファイル/サブフォルダ）一覧を取得する |

## 5. 考慮事項

-   **パスの解決**: URLやAPIで `/documents/work` のようなパス文字列が指定された場合、ルートから順にフォルダ名を解決し、目的のフォルダIDを特定するロジックが必要。
-   **パフォーマンス**: 特定のフォルダに数千・数万のアイテムが含まれる場合、一覧表示のパフォーマンスが低下する可能性がある。APIではページネーションを実装し、一度に取得するアイテム数を制限する。
-   **循環参照の防止**: フォルダの移動処理において、移動対象のフォルダを自身のサブフォルダ内に移動させようとする操作（例: `/A` を `/A/B` に移動）は、循環参照を引き起こすため禁止する必要がある。
-   **一意性制約**: 同一フォルダ内において、ファイル名とフォルダ名は一意である必要がある。データベースレベルで `(parent_folder_id, name)` の組み合わせに対するユニーク制約を設定する。
