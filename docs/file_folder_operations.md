# 設計書: ファイル・フォルダ操作

## 1. 概要

本システムにおけるファイルおよびフォルダの基本的な操作（CRUD）に関する設計を定義する。
ユーザーは、適切な権限を持つファイル/フォルダに対し、アップロード、ダウンロード、リネーム、移動、削除（論理削除）の操作を行える。

## 2. 機能要件

| No. | 機能 | 概要 | 詳細 |
| :--- | :--- | :--- | :--- |
| 2.1 | ファイルアップロード | ユーザーがローカルのファイルをシステムにアップロードする機能。 | ・一度に複数ファイルのアップロードに対応する。<br>・アップロードされたファイルはS3互換ストレージに保存され、メタデータがDBに記録される。<br>・アップロード先のフォルダに対する書き込み権限(`w`)が必要。 |
| 2.2 | ファイル/フォルダダウンロード | ユーザーがファイルやフォルダをダウンロードする機能。 | ・ファイルの場合はそのままダウンロード。<br>・フォルダの場合はZIP形式に圧縮してダウンロードする。<br>・対象アイテムに対する読み取り権限(`r`)が必要。 |
| 2.3 | ファイル/フォルダリネーム | ユーザーがファイルやフォルダの名前を変更する機能。 | ・同一階層内での名前の重複は許可しない。<br>・対象アイテムが格納されている親フォルダに対する書き込み権限(`w`)が必要。 |
| 2.4 | ファイル/フォルダ移動 | ユーザーがファイルやフォルダを別のフォルダに移動する機能。 | ・移動元フォルダと移動先フォルダの両方に対する書き込み権限(`w`)が必要。<br>・移動対象のアイテムに対する書き込み権限も必要（所有者または権限保持者）。 |
| 2.5 | ファイル/フォルダ削除（論理削除） | ユーザーがファイルやフォルダを削除する機能。 | ・削除操作は論理削除とし、`deleted_at`にタイムスタンプを記録する。<br>・対象アイテムが格納されている親フォルダに対する書き込み権限(`w`)が必要。<br>・詳細は「[削除処理設計書](./delete_process.md)」を参照。 |

## 3. 画面フロー（案）

1.  ユーザーはファイル一覧画面を表示する。
2.  画面上の「アップロード」ボタンからファイルを選択し、アップロードを実行する。
3.  一覧からファイル/フォルダを選択し、コンテキストメニューまたはアクションボタンから「ダウンロード」「リネーム」「移動」「削除」を選択する。
4.  必要に応じてダイアログが表示され、名前の入力や移動先の選択を行う。
5.  処理が実行され、成功または失敗のメッセージが表示される。

## 4. APIエンドポイント（案）

| メソッド | URI | 説明 |
| :--- | :--- | :--- |
| `POST` | `/files/upload?path=/...` | ファイルをアップロードする |
| `GET` | `/files/download?id=...` | ファイル/フォルダをダウンロードする |
| `PUT` | `/files/rename?id=...` | ファイル/フォルダ名を変更する |
| `PUT` | `/files/move?id=...&to=/...` | ファイル/フォルダを移動する |
| `DELETE` | `/files?id=...` | ファイル/フォルダを論理削除する |

## 5. 考慮事項

-   **大容量ファイルのアップロード**: アップロード処理はストリーミングで行い、メモリ消費を抑える。必要に応じてチャンクアップロードの実装も検討する。
-   **エラーハンドリング**: 各操作（特にアップロードと移動）で発生しうるエラー（権限不足, ディスク容量不足, 名前の競合など）を適切にハンドリングし、ユーザーに分かりやすいフィードバックを返す。
-   **トランザクション管理**: ファイル本体のS3保存とDBのメタデータ更新は、一連のトランザクションとして扱い、整合性を保つ。ただし、分散トランザクションになるため、リトライ処理や補償トランザクションを検討する。
