# 設計書: ファイル検索機能

## 1. 概要

ユーザーが必要なファイルを迅速に見つけられるよう、ファイル名および付与されたメタデータに基づいた検索機能を提供する。

## 2. 機能要件

| No. | 機能 | 概要 | 詳細 |
| :--- | :--- | :--- | :--- |
| 2.1 | キーワード検索 | ユーザーが入力したキーワードに基づいてファイル/フォルダを検索する。 | ・検索対象は `name`, `custom_tags`, `description` フィールドとする。<br>・キーワードが複数指定された場合、AND条件で検索する。<br>・部分一致検索を基本とする。 |
| 2.2 | 検索結果表示 | 検索結果を一覧で表示する。 | ・検索結果には、ファイル/フォルダ名、パス、更新日時、所有者などの情報を表示する。<br>・ユーザーがアクセス権限(`r`)を持つアイテムのみを表示する。 |
| 2.3 | タグによる絞り込み | ファイル詳細画面などに表示されているタグをクリックすることで、同じタグを持つファイル/フォルダを一覧表示する。 | |

## 3. 検索対象メタデータ

本機能で検索の対象とするメタデータは以下の通り。

| フィールド名 | データ型 | 検索方法 | 備考 |
| :--- | :--- | :--- | :--- |
| `name` | String | 部分一致 | ファイル/フォルダ名 |
| `custom_tags` | JSON / Text | 完全一致 / 部分一致 | ユーザー設定のタグ。タグ単位での検索を想定。 |
| `description` | Text | 部分一致 | ファイル/フォルダの説明 |

## 4. APIエンドポイント（案）

| メソッド | URI | 説明 |
| :--- | :--- | :--- |
| `GET` | `/search?q={keyword1}+{keyword2}` | 指定されたキーワードでファイル/フォルダを検索する |
| `GET` | `/search?tag={tagname}` | 指定されたタグを持つファイル/フォルダを検索する |

## 5. データベース設計とパフォーマンスに関する考慮事項

-   **インデックス**:
    -   `name` フィールドには、LIKE検索のパフォーマンスを向上させるためにインデックスを設定する。
    -   `custom_tags` フィールドがJSONやText型で複数の値を持つことを想定し、このフィールドを効率的に検索するためには**全文検索インデックス (Full-Text Index)** の利用を強く推奨する。PostgreSQLでは `GIN` や `GIST` インデックスが利用可能。
-   **権限チェックの効率**: 検索クエリ実行時に、結果セットに対してユーザーのアクセス権限をチェックする必要がある。この処理がボトルネックにならないよう、クエリレベルで権限の絞り込みを行えるように設計する。
-   **結果のページネーション**: 検索結果が大量になる可能性を考慮し、APIでは必ずページネーションを実装する。
