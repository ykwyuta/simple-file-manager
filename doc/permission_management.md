# 設計書: 権限管理

## 1. 概要

ファイルおよびフォルダへのアクセスを制御するための、Linuxライクな権限モデルの仕様を定義する。
所有者、所属グループ、その他のユーザーの3つのカテゴリに対し、「読み取り」「書き込み」「実行」の権限を割り当てることで、柔軟なアクセス制御を実現する。

## 2. 権限モデル

各ファイル/フォルダには、以下の3つの権限セットが紐づく。

1.  **所有者 (Owner)**: そのファイル/フォルダを所有するユーザー。
2.  **グループ (Group)**: そのファイル/フォルダが所属するグループ。
3.  **その他 (Others)**: 上記のいずれにも該当しない、その他の全ユーザー。

### 2.1. 権限の種類

| 権限 | 記号 | 8進数値 | 説明 |
| :--- | :--- | :--- | :--- |
| **読み取り (Read)** | `r` | 4 | ・**ファイル**: 内容を読み取る、ダウンロードする。<br>・**フォルダ**: 内容（ファイル/サブフォルダ）を一覧表示する。 |
| **書き込み (Write)** | `w` | 2 | ・**ファイル**: 内容を変更・上書きする、リネームする、削除する。<br>・**フォルダ**: 内部にファイル/フォルダを作成・削除・リネームする。 |
| **実行 (Execute)** | `x` | 1 | ・**ファイル**: (本システムでは未使用)<br>・**フォルダ**: そのフォルダにアクセスする（パスの一部として通過する）、中のアイテムにアクセスするための前提条件。 |

### 2.2. 権限の表現

-   権限は3桁の8進数（例: `750`）で表現し、データベースのメタデータテーブルに保存する。
    -   1桁目: 所有者の権限 (`r`+`w`+`x` の合計値)
    -   2桁目: グループの権限
    -   3桁目: その他の権限
-   例: `750`
    -   所有者: `7` (rwx) -> 読み取り、書き込み、実行すべて可能
    -   グループ: `5` (r-x) -> 読み取り、実行が可能
    -   その他: `0` (---) -> 全てのアクセスが不可

## 3. 権限チェックロジック

ユーザーが特定のアクション（例: ファイルAのダウンロード）を要求した際、以下の順序で権限を評価する。

1.  **管理者チェック**: ユーザーがシステム管理者（`is_admin=true`）の場合、すべての権限チェックをパスする。
2.  **所有者チェック**: ユーザーがファイルAの所有者（`owner_user_id`）と一致する場合、**所有者権限**のみを評価する。権限があれば許可、なければ拒否。
3.  **グループチェック**: ユーザーが所有者でない場合、ユーザーが所属するグループの中に、ファイルAの所属グループ（`owner_group_id`）と一致するものがあるか調べる。一致すれば、**グループ権限**のみを評価する。権限があれば許可、なければ拒否。
4.  **その他チェック**: 上記のいずれでもない場合、**その他権限**を評価する。権限があれば許可、なければ拒否。

## 4. 操作と要求権限のマッピング

| 操作 | 対象 | 要求される権限 | 備考 |
| :--- | :--- | :--- | :--- |
| ファイル一覧表示 | フォルダ | `r` (読み取り) | |
| フォルダへの進入 | フォルダ | `x` (実行) | パスを辿るために必要 |
| ファイルダウンロード | ファイル | `r` (読み取り) | |
| ファイルアップロード | 親フォルダ | `w` (書き込み) | |
| ファイル/フォルダ作成 | 親フォルダ | `w` (書き込み) | |
| ファイル/フォルダ削除 | 親フォルダ | `w` (書き込み) | |
| ファイル/フォルダリネーム | 親フォルダ | `w` (書き込み) | |
| 権限変更 (chmod) | ファイル/フォルダ | **所有者であること** | または管理者 |

## 5. APIエンドポイント（案）

| メソッド | URI | 説明 |
| :--- | :--- | :--- |
| `PUT` | `/items/{id}/permissions` | 指定したアイテムの権限を変更する。リクエストボディで `{"permissions": "644"}` のように指定。 |
| `PUT` | `/items/{id}/owner` | 指定したアイテムの所有者・グループを変更する。 |

## 6. 考慮事項

-   **デフォルトパーミッション**: 新規作成時のデフォルト権限を定義する必要がある。
    -   ファイル: `644` (所有者:rw-, グループ:r--, その他:r--)
    -   フォルダ: `755` (所有者:rwx, グループ:r-x, その他:r-x)
    -   これらは設定で変更可能とすることが望ましい。
-   **実行権限の重要性**: フォルダの実行(`x`)権限がない場合、たとえその中のファイルに対する`r`権限を持っていても、フォルダに進入できないためファイルにアクセスできない。このLinuxの挙動を忠実に再現する。
