# 設計書: 削除処理

## 1. 概要

本システムにおけるファイル/フォルダの削除処理の仕様を定義する。
ユーザーによる誤操作からの復旧を可能にするため、削除は「論理削除」と「物理削除」の二段階で実行される。

## 2. フェーズ1: 論理削除 (Soft Delete)

ユーザーがUI上でファイルやフォルダの削除操作を行った際の挙動。

### 2.1. 処理フロー

1.  ユーザーが削除対象のアイテム（ファイルまたはフォルダ）を指定し、削除を指示する。
2.  システムは、対象アイテムのメタデータレコード（`files`テーブル）の **`deleted_at`** フィールドに現在の日時（タイムスタンプ）を記録する。
3.  アイテムはユーザーの通常のビュー（ファイル一覧など）からは非表示になる。
4.  S3互換ストレージに保存されているファイル本体は、この時点では**削除されない**。

### 2.2. フォルダの論理削除

-   フォルダを論理削除した場合、そのフォルダ自身のみに`deleted_at`が設定される。
-   内部に含まれるファイルやサブフォルダには`deleted_at`は設定されない（再帰的な更新は行わない）。
-   アプリケーションのロジックで、`deleted_at`が設定されたフォルダの配下にあるアイテムは、親が削除されているものとして扱う（例: 表示しない、アクセス不可とする）。

### 2.3. 論理削除からの復元

-   「ゴミ箱」のような機能を提供し、`deleted_at`が`NOT NULL`のアイテムを一覧表示できるようにする。
-   ユーザーはゴミ箱からアイテムを選択し、「復元」操作を行える。
-   復元処理では、対象アイテムの`deleted_at`を`NULL`に戻す。フォルダの場合は、そのフォルダ自身を復元するだけで、配下のアイテムも再びアクセス可能になる。

## 3. フェーズ2: 物理削除 (Hard Delete)

論理削除されてから一定期間が経過したデータを、システムから完全に削除するバッチ処理。

### 3.1. 処理フロー

1.  **スケジューリング**: Spring Schedulerなどを用いて、定期的に（例: 毎日深夜に）バッチ処理を起動する。
2.  **対象の特定**: バッチ処理は、`deleted_at`が設定されており、かつその日時が現在から**7日間**（設定で変更可能）以上経過したレコードを`files`テーブルから検索する。
3.  **処理の実行（ファイルごと）**:
    a.  対象がファイル（`is_directory=false`）の場合、`storage_key`を使用してS3互換ストレージから**ファイル本体を物理的に削除**する。
    b.  S3からの削除が成功した後、`files`テーブルからそのファイルの**メタデータレコードを物理的に削除**する。
4.  **処理の実行（フォルダごと）**:
    a.  対象がフォルダ（`is_directory=true`）の場合、`files`テーブルからそのフォルダの**メタデータレコードを物理的に削除**する。

### 3.2. 考慮事項

-   **猶予期間**: 物理削除までの猶予期間（デフォルト7日）は、環境変数などで設定可能にすることが望ましい。
-   **エラーハンドリング**: バッチ処理中にS3への接続失敗やDBエラーが発生した場合を考慮し、リトライロジックやエラーログの詳細な記録を実装する。特定のファイルで失敗しても、他のファイルの処理は継続できるように設計する。
-   **処理順序**: フォルダを先に削除すると、中に含まれていた（がDB上は親子関係しかない）ファイルの`storage_key`が追跡不能になるリスクがある。そのため、物理削除はファイルから先に行うか、あるいは削除対象のフォルダ配下のファイルを特定してから処理するなどの順序制御が必要。最も安全なのは、`deleted_at`が設定されたファイルをまず削除し、その後、中身が空になった`deleted_at`設定済みのフォルダを削除する、という二段階のバッチ処理とすることである。
